<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My World – Book</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --paper: #f6f2ea;
      --paper-edge: #e8e0d4;
      --ink: #2c2825;
      --ink-muted: #5a5550;
      --spine-dark: #6b5d4f;
      --spine-mid: #8b7d6d;
      --spine-light: #a89888;
      --accent: #6b5344;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html { min-height: 100%; }

    body {
      font-family: 'Crimson Pro', Georgia, serif;
      background: #1a1612;
      color: var(--ink);
      min-height: 100vh;
      padding: 2rem 1rem;
      line-height: 1.5;
    }

    .book-holder {
      max-width: 1000px;
      margin: 0 auto;
    }

    .book-wrap {
      display: flex;
      align-items: stretch;
      border-radius: 0 8px 8px 0;
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,0.06),
        2px 0 12px rgba(0,0,0,0.15),
        4px 0 24px rgba(0,0,0,0.2),
        8px 8px 40px rgba(0,0,0,0.4),
        0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
      height: 580px;
    }

    .page-left {
      width: 280px;
      min-width: 260px;
      flex-shrink: 0;
      background: var(--paper);
      border-radius: 0 2px 2px 0;
      border: 1px solid var(--paper-edge);
      border-left: none;
      box-shadow: inset 12px 0 20px -12px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .page-left .page-title {
      padding: 1.25rem 1.25rem 0.5rem;
      font-size: 1.35rem;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 0.02em;
    }

    .page-left .page-sub {
      font-size: 0.8rem;
      color: var(--ink-muted);
      padding: 0 1.25rem 0.75rem;
      border-bottom: 1px solid var(--paper-edge);
    }

    .search-wrap {
      padding: 0.6rem 1rem;
      border-bottom: 1px solid var(--paper-edge);
    }

    .search-wrap input {
      width: 100%;
      padding: 0.4rem 0.6rem 0.4rem 1.75rem;
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 0.85rem;
      color: var(--ink);
      background: #fff;
      border: 1px solid var(--paper-edge);
      border-radius: 3px;
      outline: none;
    }

    .search-wrap input::placeholder { color: var(--ink-muted); }
    .search-wrap input:focus { border-color: var(--accent); }

    .continents-list {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 0.5rem 0;
    }

    .continent { margin-bottom: 0.25rem; }

    .continent-header {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--ink);
      transition: background 0.15s, color 0.15s;
    }

    .continent-header:hover {
      background: rgba(107, 83, 68, 0.08);
      color: var(--accent);
    }

    .continent-header .arrow { font-size: 0.65rem; transition: transform 0.2s; }
    .continent.expanded .continent-header .arrow { transform: rotate(90deg); }
    .continent-header .count { font-size: 0.7rem; color: var(--ink-muted); margin-left: auto; }

    .countries { max-height: 0; overflow: hidden; transition: max-height 0.25s ease; }
    .continent.expanded .countries { max-height: 260px; overflow-y: auto; }

    .country-item {
      padding: 0.25rem 1rem 0.25rem 1.75rem;
      font-size: 0.8rem;
      color: var(--ink-muted);
      cursor: pointer;
      transition: color 0.15s, background 0.15s;
    }

    .country-item:hover, .country-item.highlighted {
      color: var(--accent);
      background: rgba(107, 83, 68, 0.06);
    }

    .spine {
      width: 24px;
      flex-shrink: 0;
      background: linear-gradient(90deg, var(--spine-dark) 0%, var(--spine-mid) 15%, var(--spine-light) 50%, var(--spine-mid) 85%, var(--spine-dark) 100%);
      box-shadow: inset -2px 0 6px rgba(0,0,0,0.2), inset 2px 0 4px rgba(255,255,255,0.06);
    }

    .page-right {
      flex: 1;
      min-width: 0;
      min-height: 0;
      background: #e2ddd4;
      border-radius: 2px 0 0 2px;
      border: 1px solid var(--paper-edge);
      border-right: none;
      box-shadow: inset -12px 0 20px -12px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      overflow: hidden;
    }

    .map-container {
      width: 100%;
      height: 100%;
      min-height: 580px;
      position: relative;
      background: radial-gradient(ellipse 85% 85% at 50% 50%, #ebe6dd 0%, #d8d2c8 45%, #c9c0b4 100%);
    }

    #map {
      width: 100%;
      height: 100%;
      cursor: grab;
    }
    #map:active { cursor: grabbing; }

    .globe-circle {
      fill: #d4cdc2;
      stroke: rgba(107, 83, 68, 0.4);
      stroke-width: 1.5;
    }

    .country-path {
      fill: #b8ad9e;
      stroke: #8b7d6d;
      stroke-width: 0.35px;
      stroke-linejoin: round;
      cursor: pointer;
      transition: fill 0.2s, stroke 0.2s, opacity 0.25s;
    }
    .country-path:hover { fill: #a89888; stroke: var(--spine-mid); }
    .country-path.highlighted {
      fill: #c9bfb0;
      stroke: var(--spine-dark);
      stroke-width: 1.2px;
      filter: drop-shadow(0 0 6px rgba(107, 83, 68, 0.25));
    }
    .country-path.continent-active { fill: #c4b8a8; }
    .country-path.continent-active.highlighted { fill: #c9bfb0; }
    .map-container.country-focused .country-path:not(.highlighted) { opacity: 0.45; }

    .tooltip {
      position: fixed;
      background: var(--paper);
      color: var(--ink);
      border: 1px solid var(--paper-edge);
      padding: 0.4rem 0.6rem;
      font-size: 0.8rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 100;
      border-radius: 3px;
      font-family: 'Crimson Pro', Georgia, serif;
    }
    .tooltip.visible { opacity: 1; }
    .tooltip .country-name { font-weight: 600; color: var(--accent); }
    .tooltip .continent-name { font-size: 0.75rem; color: var(--ink-muted); }

    .search-results {
      position: absolute;
      left: 1rem;
      right: 1rem;
      top: 100%;
      margin-top: 2px;
      max-height: 180px;
      overflow-y: auto;
      background: var(--paper);
      border: 1px solid var(--paper-edge);
      border-radius: 3px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 50;
      display: none;
    }
    .search-results.visible { display: block; }
    .search-results .result-item {
      padding: 0.35rem 0.6rem;
      font-size: 0.82rem;
      color: var(--ink);
      cursor: pointer;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .search-results .result-item:hover { background: rgba(107, 83, 68, 0.08); color: var(--accent); }
    .search-wrap { position: relative; }

    .detail-btn {
      position: absolute;
      right: 12px;
      bottom: 12px;
      padding: 0.4rem 0.75rem;
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 0.85rem;
      color: var(--paper);
      background: var(--accent);
      border: 1px solid var(--spine-dark);
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 10;
    }
    .detail-btn.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .detail-btn:hover { filter: brightness(1.1); }

    .detail-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    .detail-modal-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .detail-modal {
      position: relative;
      background: var(--paper);
      border: 1px solid var(--paper-edge);
      border-radius: 6px;
      padding: 1.5rem 1.75rem;
      max-width: 320px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      font-family: 'Crimson Pro', Georgia, serif;
    }
    .detail-modal-title {
      font-size: 0.9rem;
      color: var(--ink-muted);
      font-weight: 600;
      margin-bottom: 0.75rem;
      letter-spacing: 0.02em;
    }
    .detail-modal-country {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.25rem;
    }
    .detail-modal-continent {
      font-size: 0.9rem;
      color: var(--ink-muted);
      margin-bottom: 1rem;
    }
    .detail-modal-link {
      display: inline-block;
      font-size: 0.9rem;
      color: var(--accent);
      text-decoration: underline;
    }
    .detail-modal-link:hover { color: var(--spine-dark); }
    .detail-modal-close {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 28px;
      height: 28px;
      padding: 0;
      font-size: 1.25rem;
      line-height: 1;
      color: var(--ink-muted);
      background: none;
      border: none;
      cursor: pointer;
      border-radius: 3px;
    }
    .detail-modal-close:hover { background: rgba(0,0,0,0.06); color: var(--ink); }
  </style>
</head>
<body>
  <div class="book-holder">
    <div class="book-wrap">
      <div class="page-left">
        <h1 class="page-title">My World</h1>
        <p class="page-sub">Chapter 3 — Finding countries. Choose a country — the globe turns to it. Drag to rotate, scroll to zoom.</p>
        <div class="search-wrap">
          <input type="text" id="country-search" placeholder="Search country…" autocomplete="off" />
          <div class="search-results" id="search-results"></div>
        </div>
        <nav class="continents-list" id="continents-list"></nav>
      </div>
      <div class="spine" aria-hidden="true"></div>
      <div class="page-right">
        <div class="map-container" id="map-container">
          <svg id="map"></svg>
          <button type="button" class="detail-btn" id="btn-detail" aria-label="View country details">Detail</button>
        </div>
        <div class="tooltip" id="tooltip"></div>
      </div>
    </div>
    <div class="detail-modal-overlay" id="detail-overlay" aria-hidden="true">
      <div class="detail-modal" id="detail-modal" role="dialog" aria-labelledby="detail-title">
        <h3 class="detail-modal-title" id="detail-title">Country details</h3>
        <p class="detail-modal-country" id="detail-country-name"></p>
        <p class="detail-modal-continent" id="detail-continent"></p>
        <a class="detail-modal-link" id="detail-wiki-link" href="#" target="_blank" rel="noopener">Learn more on Wikipedia</a>
        <button type="button" class="detail-modal-close" id="detail-close" aria-label="Close">×</button>
      </div>
    </div>
  </div>

  <script>
    const CONTINENTS_DATA = {
      "Africa": ["Algeria","Angola","Benin","Botswana","Burkina Faso","Burundi","Cameroon","Cabo Verde","Central African Rep.","Chad","Comoros","Congo","Dem. Rep. Congo","Côte d'Ivoire","Djibouti","Egypt","Eq. Guinea","Eritrea","eSwatini","Ethiopia","Gabon","Gambia","Ghana","Guinea","Guinea-Bissau","Kenya","Lesotho","Liberia","Libya","Madagascar","Malawi","Mali","Mauritania","Mauritius","Morocco","Mozambique","Namibia","Niger","Nigeria","Rwanda","Saint Helena","São Tomé and Principe","Senegal","Seychelles","Sierra Leone","Somalia","Somaliland","South Africa","S. Sudan","Sudan","Tanzania","Togo","Tunisia","Uganda","Zambia","Zimbabwe","W. Sahara"],
      "Asia": ["Afghanistan","Armenia","Azerbaijan","Bahrain","Bangladesh","Bhutan","Brunei","Cambodia","China","Cyprus","Georgia","Hong Kong","India","Indonesia","Iran","Iraq","Israel","Japan","Jordan","Kazakhstan","Kuwait","Kyrgyzstan","Laos","Lebanon","Macao","Malaysia","Maldives","Mongolia","Myanmar","Nepal","North Korea","Oman","Pakistan","Palestine","Philippines","Qatar","Saudi Arabia","Singapore","South Korea","Sri Lanka","Syria","Taiwan","Tajikistan","Thailand","Timor-Leste","Turkey","Turkmenistan","United Arab Emirates","Uzbekistan","Vietnam","Yemen","N. Cyprus"],
      "Europe": ["Albania","Andorra","Austria","Belarus","Belgium","Bosnia and Herz.","Bulgaria","Croatia","Czechia","Denmark","Estonia","Finland","France","Germany","Greece","Hungary","Iceland","Ireland","Italy","Kosovo","Latvia","Liechtenstein","Lithuania","Luxembourg","Macedonia","Malta","Moldova","Monaco","Montenegro","Netherlands","Norway","Poland","Portugal","Romania","Russia","San Marino","Serbia","Slovakia","Slovenia","Spain","Sweden","Switzerland","Ukraine","United Kingdom","Vatican","Åland","Faeroe Is.","Guernsey","Isle of Man","Jersey"],
      "North America": ["Antigua and Barbuda","Aruba","Bahamas","Barbados","Belize","Canada","Costa Rica","Cuba","Curaçao","Dominica","Dominican Rep.","El Salvador","Grenada","Guatemala","Haiti","Honduras","Jamaica","Mexico","Nicaragua","Panama","St. Kitts and Nevis","St. Lucia","St. Vin. and Gren.","St-Barthélemy","St-Martin","Trinidad and Tobago","United States of America","Anguilla","Bermuda","British Virgin Is.","Cayman Is.","Greenland","Montserrat","Puerto Rico","St. Pierre and Miquelon","Turks and Caicos Is.","U.S. Virgin Is."],
      "South America": ["Argentina","Bolivia","Brazil","Chile","Colombia","Ecuador","Guyana","Paraguay","Peru","Suriname","Uruguay","Venezuela","Falkland Is."],
      "Oceania": ["Australia","Fiji","Kiribati","Marshall Is.","Micronesia","Nauru","New Zealand","Palau","Papua New Guinea","Samoa","Solomon Is.","Tonga","Tuvalu","Vanuatu","American Samoa","Cook Is.","Fr. Polynesia","Guam","New Caledonia","Niue","N. Mariana Is.","Pitcairn Is.","Wallis and Futuna Is."],
      "Antarctica": ["Antarctica","Fr. S. Antarctic Lands","Br. Indian Ocean Ter.","S. Geo. and the Is."]
    };

    let worldData = null, countryToContinent = {}, selectedContinent = null, selectedCountry = null, hoveredCountry = null;
    let projection = null, pathGenerator = null, countriesFeatures = null, mapGroup = null;
    let currentCenter = [0, 25], currentScale = null, baseScale = null, animating = false, isDragging = false;
    const ZOOM_IN_FACTOR = 2, DRAG_SENSITIVITY = 0.35, WHEEL_ZOOM_FACTOR = 1.08, MIN_ZOOM = 0.4, MAX_ZOOM = 4;

    for (const [c, list] of Object.entries(CONTINENTS_DATA)) list.forEach(name => { countryToContinent[name] = c; });

    const CONTINENT_CENTERS = {
      "Africa": [20, 0],
      "Asia": [100, 35],
      "Europe": [15, 50],
      "North America": [-100, 45],
      "South America": [-60, -15],
      "Oceania": [135, -25],
      "Antarctica": [0, -80]
    };

    async function loadData() {
      const topo = await (await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json')).json();
      worldData = { topo, continents: CONTINENTS_DATA };
      render();
    }

    function render() {
      const { topo, continents } = worldData;
      const countries = topojson.feature(topo, topo.objects.countries);
      countriesFeatures = countries.features;
      const container = document.getElementById('map-container');
      const width = container.clientWidth;
      const height = container.clientHeight;
      const size = Math.min(width, height);
      const cx = width / 2, cy = height / 2;
      baseScale = size / 2 - 4;
      if (currentScale == null) currentScale = baseScale;
      projection = d3.geoOrthographic().scale(currentScale).translate([cx, cy]).clipAngle(90).rotate([-currentCenter[0], -currentCenter[1], 0]);
      pathGenerator = d3.geoPath().projection(projection);

      const svg = d3.select('#map').attr('viewBox', [0, 0, width, height]).attr('preserveAspectRatio', 'xMidYMid meet');
      svg.selectAll('*').remove();

      const scale = currentScale ?? baseScale;
      svg.append('defs').append('clipPath').attr('id', 'globe-clip').append('circle').attr('cx', cx).attr('cy', cy).attr('r', scale);
      svg.append('circle').attr('class', 'globe-circle').attr('cx', cx).attr('cy', cy).attr('r', scale);
      mapGroup = svg.append('g').attr('clip-path', 'url(#globe-clip)');
      mapGroup.selectAll('path').data(countries.features).join('path')
        .attr('class', 'country-path').attr('d', pathGenerator).attr('data-name', d => d.properties?.name || '')
        .on('mouseenter', function(ev, d) { hoveredCountry = d.properties?.name || ''; updateHighlights(); showTooltip(ev, hoveredCountry); })
        .on('mousemove', moveTooltip)
        .on('mouseleave', () => { hoveredCountry = null; updateHighlights(); hideTooltip(); })
        .on('click', function(ev, d) { if (isDragging) return; const n = d.properties?.name || ''; if (countryToContinent[n]) selectContinent(countryToContinent[n]); spinToCountry(n); });

      svg.call(d3.drag()
        .on('start', () => { isDragging = false; })
        .on('drag', function(ev) {
          isDragging = true;
          currentCenter[0] -= ev.dx * DRAG_SENSITIVITY;
          currentCenter[1] += ev.dy * DRAG_SENSITIVITY;
          currentCenter[1] = Math.max(-85, Math.min(85, currentCenter[1]));
          projection.rotate([-currentCenter[0], -currentCenter[1], 0]);
          pathGenerator.projection(projection);
          mapGroup.selectAll('.country-path').attr('d', pathGenerator);
        })
        .on('end', () => { setTimeout(() => { isDragging = false; }, 0); }));

      svg.on('wheel', function(ev) {
        ev.preventDefault();
        if (!baseScale || !projection || !pathGenerator || !mapGroup) return;
        const k = ev.deltaY > 0 ? 1 / WHEEL_ZOOM_FACTOR : WHEEL_ZOOM_FACTOR;
        currentScale = Math.max(baseScale * MIN_ZOOM, Math.min(baseScale * MAX_ZOOM, currentScale * k));
        projection.scale(currentScale);
        pathGenerator.projection(projection);
        mapGroup.selectAll('.country-path').attr('d', pathGenerator);
        updateGlobeCircle();
      }, { passive: false });

      renderSidebar(continents);
      setupSearch();
    }

    function spinToCountry(countryName) {
      if (!countriesFeatures || !projection || !pathGenerator || !mapGroup || animating) return;
      const feature = countriesFeatures.find(f => (f.properties?.name || '') === countryName);
      if (!feature) return;
      selectedCountry = countryName;
      updateHighlights();
      let targetCenter;
      try { targetCenter = d3.geoCentroid(feature); } catch (e) { const b = d3.geoBounds(feature); targetCenter = [(b[0][0]+b[1][0])/2, (b[0][1]+b[1][1])/2]; }
      const startCenter = currentCenter.slice();
      let lon = targetCenter[0];
      while (lon - startCenter[0] > 180) lon -= 360;
      while (lon - startCenter[0] < -180) lon += 360;
      targetCenter = [lon, targetCenter[1]];
      animating = true;
      const zoomOutDuration = 600, spinDuration = 1200, zoomInDuration = 600;
      const startTime = performance.now();
      const startScale = currentScale ?? baseScale ?? projection.scale();
      const theBaseScale = baseScale ?? startScale;
      const targetScale = theBaseScale * ZOOM_IN_FACTOR;
      const needZoomOut = theBaseScale > 0 && startScale > theBaseScale * 1.05;

      function tick(now) {
        const elapsed = now - startTime;
        let phaseStart = needZoomOut ? zoomOutDuration : 0;
        if (needZoomOut && elapsed < zoomOutDuration) {
          const t = Math.min(1, elapsed / zoomOutDuration);
          const e = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
          currentScale = startScale + (theBaseScale - startScale) * e;
        }
        if (elapsed >= phaseStart && elapsed < phaseStart + spinDuration) {
          const t = Math.min(1, (elapsed - phaseStart) / spinDuration);
          const e = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
          currentCenter[0] = startCenter[0] + (targetCenter[0] - startCenter[0]) * e;
          currentCenter[1] = startCenter[1] + (targetCenter[1] - startCenter[1]) * e;
          currentScale = theBaseScale;
        } else if (elapsed >= phaseStart + spinDuration) {
          currentCenter[0] = targetCenter[0]; currentCenter[1] = targetCenter[1];
          const t = Math.min(1, (elapsed - phaseStart - spinDuration) / zoomInDuration);
          const e = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
          currentScale = theBaseScale + (targetScale - theBaseScale) * e;
        }
        projection.rotate([-currentCenter[0], -currentCenter[1], 0]).scale(currentScale);
        pathGenerator.projection(projection);
        mapGroup.selectAll('.country-path').attr('d', pathGenerator);
        updateGlobeCircle();
        if (elapsed < phaseStart + spinDuration + zoomInDuration) requestAnimationFrame(tick);
        else { currentScale = targetScale; updateGlobeCircle(); animating = false; }
      }
      requestAnimationFrame(tick);
    }

    function updateGlobeCircle() {
      const scale = currentScale ?? baseScale;
      if (scale == null) return;
      const sel = d3.select('#map');
      if (!sel.empty()) {
        sel.select('#globe-clip circle').attr('r', scale);
        sel.select('.globe-circle').attr('r', scale);
      }
    }

    function spinToContinent(continentName) {
      if (!projection || !pathGenerator || !mapGroup || animating) return;
      const target = CONTINENT_CENTERS[continentName];
      if (!target) return;
      const startCenter = currentCenter.slice();
      let lon = target[0];
      while (lon - startCenter[0] > 180) lon -= 360;
      while (lon - startCenter[0] < -180) lon += 360;
      const targetCenter = [lon, target[1]];
      animating = true;
      const duration = 800;
      const startTime = performance.now();
      function tick(now) {
        const elapsed = Math.min(now - startTime, duration);
        const t = elapsed / duration;
        const e = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
        currentCenter[0] = startCenter[0] + (targetCenter[0] - startCenter[0]) * e;
        currentCenter[1] = startCenter[1] + (targetCenter[1] - startCenter[1]) * e;
        projection.rotate([-currentCenter[0], -currentCenter[1], 0]);
        pathGenerator.projection(projection);
        mapGroup.selectAll('.country-path').attr('d', pathGenerator);
        if (elapsed < duration) requestAnimationFrame(tick);
        else animating = false;
      }
      requestAnimationFrame(tick);
    }

    function renderSidebar(continents) {
      const list = document.getElementById('continents-list');
      list.innerHTML = '';
      for (const [name, countries] of Object.entries(continents)) {
        const div = document.createElement('div');
        div.className = 'continent';
        div.innerHTML = `<div class="continent-header" data-continent="${name}"><span class="arrow">›</span><span class="name">${name}</span><span class="count">${countries.length}</span></div><div class="countries">${countries.map(c => `<div class="country-item" data-country="${c}">${c}</div>`).join('')}</div>`;
        list.appendChild(div);
      }
      document.querySelectorAll('.continent-header').forEach(el => {
        el.addEventListener('click', () => {
          const continent = el.dataset.continent;
          const parent = el.closest('.continent');
          const wasExpanded = parent.classList.contains('expanded');
          document.querySelectorAll('.continent').forEach(c => { c.classList.remove('expanded'); });
          if (!wasExpanded) {
            parent.classList.add('expanded');
            selectContinent(continent);
            spinToContinent(continent);
          } else {
            selectContinent(null);
          }
        });
      });
      document.querySelectorAll('.country-item').forEach(el => {
        el.addEventListener('click', e => { e.stopPropagation(); const c = el.dataset.country; if (countryToContinent[c]) selectContinent(countryToContinent[c]); hoveredCountry = c; updateHighlights(); spinToCountry(c); });
        el.addEventListener('mouseenter', () => { hoveredCountry = el.dataset.country; updateHighlights(); });
        el.addEventListener('mouseleave', () => { hoveredCountry = null; updateHighlights(); });
      });
    }

    function setupSearch() {
      const allCountries = [];
      for (const [continent, countries] of Object.entries(CONTINENTS_DATA)) countries.forEach(c => allCountries.push({ name: c, continent }));
      const input = document.getElementById('country-search');
      const resultsEl = document.getElementById('search-results');
      if (!input || !resultsEl) return;
      function showResults(matches) {
        resultsEl.innerHTML = '';
        if (matches.length === 0) { resultsEl.classList.remove('visible'); return; }
        matches.slice(0, 10).forEach(m => {
          const div = document.createElement('div');
          div.className = 'result-item';
          div.textContent = m.name;
          div.addEventListener('click', () => { input.value = ''; resultsEl.classList.remove('visible'); if (countryToContinent[m.name]) selectContinent(countryToContinent[m.name]); selectedCountry = m.name; updateHighlights(); spinToCountry(m.name); });
          resultsEl.appendChild(div);
        });
        resultsEl.classList.add('visible');
      }
      input.addEventListener('input', () => { const q = (input.value || '').trim().toLowerCase(); showResults(q.length < 2 ? [] : allCountries.filter(({ name }) => name.toLowerCase().includes(q))); });
      document.addEventListener('click', e => { if (!input.contains(e.target) && !resultsEl.contains(e.target)) resultsEl.classList.remove('visible'); });
    }

    function selectContinent(continent) {
      selectedContinent = continent;
      document.querySelectorAll('.continent-header').forEach(el => el.classList.toggle('active', el.dataset.continent === continent));
      updateHighlights();
    }

    function updateHighlights() {
      const paths = document.querySelectorAll('.country-path');
      const items = document.querySelectorAll('.country-item');
      const container = document.getElementById('map-container');
      const detailBtn = document.getElementById('btn-detail');
      if (container) container.classList.toggle('country-focused', !!selectedCountry);
      if (detailBtn) detailBtn.classList.toggle('visible', !!selectedCountry);
      paths.forEach(path => {
        const name = path.dataset.name;
        const continent = countryToContinent[name];
        const isSelected = name === selectedCountry;
        const inSelected = !selectedContinent || continent === selectedContinent;
        path.classList.toggle('continent-active', inSelected && selectedContinent);
        path.classList.toggle('highlighted', isSelected);
        path.style.opacity = selectedCountry && !isSelected ? 0.4 : (selectedContinent && !inSelected ? 0.2 : 1);
      });
      items.forEach(item => item.classList.toggle('highlighted', item.dataset.country === selectedCountry || item.dataset.country === hoveredCountry));
    }

    function openDetailModal() {
      if (!selectedCountry) return;
      const overlay = document.getElementById('detail-overlay');
      const nameEl = document.getElementById('detail-country-name');
      const continentEl = document.getElementById('detail-continent');
      const linkEl = document.getElementById('detail-wiki-link');
      if (!overlay || !nameEl || !continentEl || !linkEl) return;
      nameEl.textContent = selectedCountry;
      continentEl.textContent = 'Continent: ' + (countryToContinent[selectedCountry] || '—');
      const wikiSlug = encodeURIComponent(selectedCountry.replace(/\s+/g, '_'));
      linkEl.href = 'https://en.wikipedia.org/wiki/' + wikiSlug;
      overlay.classList.add('visible');
      overlay.setAttribute('aria-hidden', 'false');
    }

    function closeDetailModal() {
      const overlay = document.getElementById('detail-overlay');
      if (overlay) {
        overlay.classList.remove('visible');
        overlay.setAttribute('aria-hidden', 'true');
      }
    }

    function setupDetailModal() {
      const btn = document.getElementById('btn-detail');
      const overlay = document.getElementById('detail-overlay');
      const closeBtn = document.getElementById('detail-close');
      if (btn) btn.addEventListener('click', openDetailModal);
      if (closeBtn) closeBtn.addEventListener('click', closeDetailModal);
      if (overlay) overlay.addEventListener('click', function(e) { if (e.target === overlay) closeDetailModal(); });
    }

    function showTooltip(ev, countryName) {
      const tooltip = document.getElementById('tooltip');
      tooltip.innerHTML = `<span class="country-name">${countryName}</span><br><span class="continent-name">${countryToContinent[countryName] || '—'}</span>`;
      tooltip.classList.add('visible');
      moveTooltip(ev);
    }
    function moveTooltip(ev) {
      const t = document.getElementById('tooltip');
      let left = ev.clientX + 12, top = ev.clientY + 12;
      const r = t.getBoundingClientRect();
      if (left + r.width > window.innerWidth) left = ev.clientX - r.width - 12;
      if (top + r.height > window.innerHeight) top = ev.clientY - r.height - 12;
      t.style.left = left + 'px'; t.style.top = top + 'px';
    }
    function hideTooltip() { document.getElementById('tooltip').classList.remove('visible'); }

    window.addEventListener('resize', () => worldData && render());
    setupDetailModal();
    loadData();
  </script>
</body>
</html>
